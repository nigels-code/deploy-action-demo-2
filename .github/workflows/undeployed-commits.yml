name: undeployed-commits

on:
    workflow_dispatch:

jobs:
    undeployed-commits:
        runs-on: ubuntu-latest

        steps:

            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: List commits not deployed to prod
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  # Get the last successful production deployment SHA
                  # We need to check deployment statuses since pending deployments also appear in the API
                  LAST_DEPLOY_SHA=$(gh api \
                    "repos/${{ github.repository }}/deployments?environment=prod&per_page=20" \
                    --jq '.[].id' | while read -r deploy_id; do
                      status=$(gh api "repos/${{ github.repository }}/deployments/${deploy_id}/statuses" --jq '.[0].state')
                      if [ "$status" = "success" ]; then
                        gh api "repos/${{ github.repository }}/deployments/${deploy_id}" --jq '.sha'
                        break
                      fi
                    done)

                  if [ -z "$LAST_DEPLOY_SHA" ]; then
                    echo "No successful production deployments found"
                    exit 0
                  fi

                  echo "Last production deployment: $LAST_DEPLOY_SHA"
                  echo "Current HEAD: ${{ github.sha }}"
                  echo ""
                  echo "Commits not yet deployed to production:"
                  echo "========================================="

                  # List commits between last deploy and current HEAD
                  # Ignore GitHub's automatic PR merge commits, but keep developer merge commits
                  gh api \
                    "repos/${{ github.repository }}/compare/${LAST_DEPLOY_SHA}...${{ github.sha }}" \
                    --jq '.commits[] | select(.commit.message | startswith("Merge pull request #") | not) | "â€¢ \(.sha[0:7]) - \(.commit.message | split("\n")[0]) (\(.author.login // .commit.author.name))"'